
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>{{.Title}}</title>
<style>
body {
  margin: 0;
  font-family: "Fira Sans", "Segoe UI", "Trebuchet MS", system-ui, -apple-system, sans-serif;
  background: radial-gradient(circle at 20% 20%, #0f172a, #0b1220 35%, #050915);
  color: #e5e7eb;
  min-height: 100vh;
}
.shell {
  max-width: 1200px;
  margin: 0 auto;
  padding: 32px 20px 80px;
}
.topbar {
  display: flex;
  align-items: baseline;
  gap: 16px;
  flex-wrap: wrap;
  margin-bottom: 18px;
}
.title {
  font-size: 28px;
  font-weight: 700;
  letter-spacing: 0.4px;
}
.meta {
  color: #94a3b8;
  font-size: 14px;
  margin-top: 6px;
}
.actions {
  margin-left: auto;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}
.control {
  display: flex;
  align-items: center;
  gap: 8px;
  color: #cbd5e1;
  font-size: 13px;
}
.control input[type="number"] {
  width: 70px;
  padding: 6px 8px;
  border-radius: 8px;
  border: 1px solid rgba(148, 163, 184, 0.5);
  background: rgba(15, 23, 42, 0.6);
  color: #e5e7eb;
}
.toggle {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
  user-select: none;
}
input[type="checkbox"] {
  width: 16px;
  height: 16px;
}
button {
  background: linear-gradient(120deg, #22d3ee, #3b82f6);
  color: #0b1220;
  border: none;
  border-radius: 10px;
  padding: 10px 14px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 8px 30px rgba(34, 211, 238, 0.25);
  transition: transform 120ms ease, box-shadow 120ms ease;
}
button:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 34px rgba(59, 130, 246, 0.3);
}
.grid {
  margin-top: 24px;
  display: grid;
  gap: 20px;
  grid-template-columns: repeat(auto-fit, minmax(360px, 1fr));
  align-items: stretch;
}
.card {
  background: linear-gradient(135deg, rgba(148, 163, 184, 0.08), rgba(100, 116, 139, 0.05));
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 14px;
  padding: 16px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  backdrop-filter: blur(4px);
  display: flex;
  flex-direction: column;
  gap: 10px;
  height: 100%;
  box-sizing: border-box;
  min-width: 0;
}
.card h2 {
  margin: 0;
  font-size: 18px;
  letter-spacing: 0.3px;
}
.changed {
  background: linear-gradient(120deg, #22c55e, #10b981);
  color: #0b1220;
}
.pill {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 12px;
  letter-spacing: 0.2px;
  background: #0ea5e9;
  color: #0b1220;
  font-weight: 700;
}
.pill.warm {
  background: #fbbf24;
  color: #0b1220;
}
.error {
  color: #fca5a5;
  font-weight: 600;
}
.chart {
  margin-top: 6px;
}
 .gauge {
  width: 150px;
  height: 150px;
  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}
.gauge-ring {
  position: absolute;
  inset: 0;
  border-radius: 50%;
  background: conic-gradient(
    #22d3ee calc(var(--val) * 1%),
    rgba(148,163,184,0.2) calc(var(--val) * 1%),
    rgba(148,163,184,0.2) 100%
  );
}
.gauge-center {
  position: relative;
  width: 100px;
  height: 100px;
  border-radius: 50%;
  background: #0b1220;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 4px;
  color: #e5e7eb;
  box-shadow: inset 0 0 0 1px rgba(148,163,184,0.3);
  font-weight: 700;
  text-align: center;
}
.gauge-label {
  font-size: 13px;
  color: #94a3b8;
  font-weight: 600;
  max-width: 110px;
  line-height: 1.2;
  word-break: break-word;
}
.gauge-hint {
  font-size: 11px;
  color: #64748b;
}
.gauge-label.gauge-label-small {
  font-size: 12px;
}
.gauge-grid {
  display: grid;
  justify-content: center;
  justify-items: center;
  gap: 12px;
}
.gauge-grid-1 {
  grid-template-columns: 1fr;
}
.gauge-grid-2col {
  grid-template-columns: 1fr;
}
.gauge-grid-row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  justify-content: center;
  align-items: center;
}
.gauge-lg {
  width: 230px;
  height: 230px;
}
.gauge-lg .gauge-center {
  width: 150px;
  height: 150px;
}
.gauge-md {
  width: 180px;
  height: 180px;
}
.gauge-md .gauge-center {
  width: 120px;
  height: 120px;
}
.gauge {
  justify-self: center;
}
svg.timeline line {
  stroke: rgba(148, 163, 184, 0.6);
  stroke-width: 2;
}
.timeline {
  width: 100%;
}
svg.timeline circle {
  fill: #22d3ee;
  stroke: #0b1220;
  stroke-width: 1.5;
}
svg.timeline circle.changed {
  fill: #22c55e;
}
svg.timeline circle.error {
  fill: #f87171;
}
details summary {
  cursor: pointer;
  color: #cbd5e1;
  font-weight: 600;
}
details {
  background: rgba(15, 23, 42, 0.5);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 10px;
  padding: 8px 10px;
}
details pre {
  margin-top: 6px;
}
pre {
  background: rgba(15, 23, 42, 0.7);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 10px;
  padding: 12px;
  margin: 0;
  color: #cbd5e1;
  white-space: pre-wrap;
  word-break: break-word;
  overflow-wrap: anywhere;
  font-family: "JetBrains Mono", "SFMono-Regular", Consolas, Menlo, monospace;
  font-size: 13px;
}
.stack {
  display: flex;
  flex-direction: column;
  gap: 8px;
}
small {
  color: #94a3b8;
}
.hint {
  color: #94a3b8;
  font-size: 12px;
}
.summary {
  color: #e5e7eb;
  font-weight: 600;
  margin-top: 4px;
  white-space: pre-wrap;
  word-break: break-all;
  overflow-wrap: anywhere;
}
.panel {
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 14px;
  padding: 14px 16px;
  background: rgba(15, 23, 42, 0.6);
  box-shadow: 0 16px 30px rgba(2, 6, 23, 0.35);
}
.panel h3 {
  margin: 0 0 6px 0;
  font-size: 16px;
  color: #e2e8f0;
}
.panel .hint {
  display: block;
}
.alert-controls {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: flex-end;
  margin-bottom: 10px;
}
.alert-controls label {
  display: block;
  font-size: 12px;
  color: #94a3b8;
  margin-bottom: 4px;
}
.alert-controls select,
.alert-controls input {
  width: 97%;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid rgba(148, 163, 184, 0.3);
  background: #0b1220;
  color: #e5e7eb;
  font-weight: 600;
}
.alert-controls .grow {
  flex: 1 1 240px;
}
.alert-controls .alert-action {
  display: flex;
  flex-direction: column;
}
.alert-controls label.spacer {
  visibility: hidden;
}
.alert-controls .clear-button {
  align-self: flex-end;
  height: 36px;
}
.detail-box {
  max-height: 260px;
  overflow: auto;
  padding-right: 4px;
}
.rules-form {
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.rules-toolbar {
  display: flex;
  gap: 8px;
  justify-content: space-between;
  align-items: center;
}
.rules-layout {
  display: grid;
  grid-template-columns: minmax(240px, 320px) minmax(0, 1fr);
  gap: 12px;
}
.rules-layout .rules-table-wrap,
.rules-layout .metrics-panel {
  align-self: start;
}
@media (max-width: 900px) {
  .rules-layout {
    grid-template-columns: 1fr;
  }
  .rules-table {
    min-width: 700px;
  }
}
.metrics-controls {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}
.metrics-controls input {
  min-width: 200px;
  background: #0b1220;
  color: #e5e7eb;
  border: 1px solid rgba(148, 163, 184, 0.3);
  border-radius: 8px;
  padding: 6px 8px;
  box-sizing: border-box;
}
.metrics-panel {
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 12px;
  padding: 10px;
  background: linear-gradient(165deg, rgba(15, 23, 42, 0.65), rgba(30, 41, 59, 0.35));
  box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.08);
}
.metrics-panel .metrics-title {
  font-size: 13px;
  font-weight: 700;
  letter-spacing: 0.4px;
  text-transform: uppercase;
  color: #e5e7eb;
}
.metrics-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-top: 8px;
  max-height: 240px;
  overflow: auto;
  padding-right: 4px;
}
.metrics-row {
  display: flex;
  gap: 8px;
  align-items: center;
}
.metrics-row input {
  flex: 1 1 auto;
  background: #0b1220;
  color: #e5e7eb;
  border: 1px solid rgba(148, 163, 184, 0.3);
  border-radius: 8px;
  padding: 6px 8px;
  box-sizing: border-box;
}
.rules-table-wrap {
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 12px;
  overflow: auto;
  background: linear-gradient(180deg, rgba(15, 23, 42, 0.7), rgba(15, 23, 42, 0.45));
  box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.08);
}
.rules-table {
  width: 100%;
  border-collapse: collapse;
  min-width: 900px;
}
.rules-table th,
.rules-table td {
  border-bottom: 1px solid rgba(148, 163, 184, 0.15);
  padding: 8px 10px;
  text-align: left;
  vertical-align: top;
}
.rules-table tbody tr:nth-child(odd) {
  background: rgba(15, 23, 42, 0.2);
}
.rules-table th {
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.4px;
  color: #94a3b8;
  background: rgba(15, 23, 42, 0.85);
  position: sticky;
  top: 0;
  z-index: 1;
}
.rules-table input,
.rules-table select {
  width: 100%;
  padding: 6px 8px;
  border-radius: 8px;
  border: 1px solid rgba(148, 163, 184, 0.3);
  background: #0b1220;
  color: #e5e7eb;
  font-weight: 600;
  box-sizing: border-box;
}
.rules-table th:nth-child(8),
.rules-table td:nth-child(8) {
  width: 140px;
}
.rules-table th:nth-child(6),
.rules-table td:nth-child(6) {
  width: 80px;
}
.rules-table th:nth-child(9),
.rules-table td:nth-child(9) {
  min-width: 260px;
}
.rules-table input[type="checkbox"] {
  width: 16px;
  height: 16px;
}
.rules-form .primary-button {
  align-self: flex-start;
  background: #22c55e;
  color: #0b1220;
  border: none;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 700;
}
.rules-form .primary-button:hover {
  background: #16a34a;
}
.ghost {
  background: transparent;
  border: 1px solid rgba(148, 163, 184, 0.5);
  color: #e5e7eb;
  padding: 6px 12px;
  border-radius: 8px;
  cursor: pointer;
}
.ghost:hover {
  border-color: #e5e7eb;
}
.alert-list {
  list-style: none;
  padding: 0;
  margin: 6px 0 0 0;
  display: flex;
  flex-direction: column;
  gap: 4px;
}
.alert-list li {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom:2px;
  flex-wrap: wrap;
  cursor: pointer;
}
.alert-detail-grid {
  display: grid;
  gap: 12px;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  margin-top: 12px;
}
.alert-detail-label {
  display: block;
  font-size: 12px;
  color: #94a3b8;
  margin-bottom: 4px;
}
.alert-detail-pre {
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 10px;
  padding: 10px 12px;
  white-space: pre-wrap;
  word-break: break-word;
  margin-top: 6px;
}
.severity-info { background: #38bdf8; color: #0b1220; }
.severity-low { background: #a3e635; color: #0b1220; }
.severity-medium { background: #fbbf24; color: #0b1220; }
.severity-high { background: #f97316; color: #0b1220; }
.severity-critical { background: #f43f5e; color: #0b1220; }
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.35);
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
  z-index: 10;
}
.modal.show {
  display: flex;
}
.modal-content {
  background: #0b1220;
  border: 1px solid rgba(148, 163, 184, 0.2);
  border-radius: 12px;
  padding: 20px 22px;
  width: min(900px, 88vw);
  max-height: 86vh;
  overflow: auto;
}
#rulesModal .modal-content {
  width: min(1280px, 96vw);
}
</style>
</head>
<body>
  <div class="shell">
    <div class="topbar">
      <div>
        <div class="title">{{.Title}}</div>
        <div class="meta">Refreshed at {{.RefreshedAt}} • Capture every {{printf "%.0f" (divMS .CaptureIntervalMS) }}s</div>
      </div>
      <div class="actions">
        <button class="ghost" id="rulesBtn">Rules</button>
        <div class="control toggle">
          <input type="checkbox" id="eventRefresh" {{if .EventRefresh}}checked{{end}} />
          <label for="eventRefresh">Refresh on capture</label>
        </div>
        <div class="control toggle">
          <input type="checkbox" id="autoRefresh" {{if .AutoRefresh}}checked{{end}} />
          <label for="autoRefresh">Timed refresh</label>
        </div>
        <div class="control">
          every <input type="number" id="refreshInterval" min="1" value="{{.RefreshSecs}}" /> sec
        </div>
        <button id="refreshBtn" onclick="location.reload()">Refresh now</button>
      </div>
    </div>

    <div class="panel" id="alertPanel" style="margin-bottom:14px;">
      <h3>Alert history</h3>
      <span class="hint">Latest detections across all capturers (kept in memory).</span>
      <div class="alert-controls">
        <div>
          <label for="alertFilterSeverity">Severity</label>
          <select id="alertFilterSeverity">
            <option value="">All</option>
            <option value="info">Info</option>
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
            <option value="critical">Critical</option>
          </select>
        </div>
        <div class="grow">
          <label for="alertFilterText">Search</label>
          <input id="alertFilterText" type="text" placeholder="Title, message, rule id, source" />
        </div>
        <div class="alert-action">
          <label class="spacer" aria-hidden="true">Action</label>
          <button class="ghost clear-button" id="alertFilterClear">Clear</button>
        </div>
      </div>
      <div id="alertHistoryBody">
        {{if .GlobalAlerts}}
          <ul class="alert-list" id="alertHistoryList">
            {{range .GlobalAlerts}}
              <li data-id="{{.ID}}" data-severity="{{.Severity}}" data-rule="{{.RuleID}}" data-source="{{.Source}}" data-title="{{.Title}}" data-message="{{.Message}}" data-at="{{.At}}" data-text="{{.Title}} {{.Message}} {{.RuleID}} {{.Source}}" data-evidence="{{.Evidence}}" data-meta="{{.Meta}}" data-related="{{.Related}}">
                <span class="pill severity-{{.Severity}}">{{.Severity}}</span>
                <strong>{{.Title}}</strong> — {{.Message}}
                <span class="hint">{{.At}}</span>
              </li>
            {{end}}
          </ul>
        {{else}}
          <div class="hint">No alerts recorded yet.</div>
        {{end}}
      </div>
    </div>

    <div class="grid">
      {{range .Items}}
      <div class="card">
        <div class="stack">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <h2>{{.Name}}</h2>
            {{if .Error}}<span class="pill" style="background:#f87171;color:#0b1220;">error</span>{{end}}
            {{if .Changed}}<span class="pill changed">changed</span>{{end}}
            {{if .Warming}}<span class="pill warm">warming up</span>{{end}}
          </div>
          {{if .Error}}
            <div class="error">{{.Error}}</div>
          {{else}}
            {{if .Graphs}}
            {{/* Choose layout based on graph count: 1 -> enlarged; 2 -> column; else -> row wrap */}}
            {{if eq (len .Graphs) 1}}
              <div class="gauge-grid gauge-grid-1">
                {{range .Graphs}}
                <div class="gauge gauge-lg" style="--val: {{printf "%.1f" .Display}}">
                  <div class="gauge-ring"></div>
                  <div class="gauge-center">
                    <div>{{if .ValueText}}{{.ValueText}}{{else}}{{printf "%.1f%%" .Value}}{{end}}</div>
                    <div class="gauge-label {{if hasNL .Label}}gauge-label-small{{end}}">{{.Label}}</div>
                    {{if .MaxHint}}<div class="gauge-hint">{{.MaxHint}}</div>{{end}}
                  </div>
                </div>
                {{end}}
              </div>
            {{else if eq (len .Graphs) 2}}
              <div class="gauge-grid gauge-grid-2col">
                {{range .Graphs}}
                <div class="gauge gauge-md" style="--val: {{printf "%.1f" .Display}}">
                  <div class="gauge-ring"></div>
                  <div class="gauge-center">
                    <div>{{if .ValueText}}{{.ValueText}}{{else}}{{printf "%.1f%%" .Value}}{{end}}</div>
                    <div class="gauge-label {{if hasNL .Label}}gauge-label-small{{end}}">{{.Label}}</div>
                    {{if .MaxHint}}<div class="gauge-hint">{{.MaxHint}}</div>{{end}}
                  </div>
                </div>
                {{end}}
              </div>
            {{else}}
              <div class="gauge-grid gauge-grid-row">
                {{range .Graphs}}
                <div class="gauge" style="--val: {{printf "%.1f" .Display}}">
                  <div class="gauge-ring"></div>
                  <div class="gauge-center">
                    <div>{{if .ValueText}}{{.ValueText}}{{else}}{{printf "%.1f%%" .Value}}{{end}}</div>
                    <div class="gauge-label {{if hasNL .Label}}gauge-label-small{{end}}">{{.Label}}</div>
                    {{if .MaxHint}}<div class="gauge-hint">{{.MaxHint}}</div>{{end}}
                  </div>
                </div>
                {{end}}
              </div>
            {{end}}
            {{end}}
            <div>
              <small>summary</small>
              <div class="summary">{{.Display}}</div>
            </div>
            {{if .Verbose}}
            <details class="detail-box" data-item="{{.Name}}-verbose">
              <summary>Verbose</summary>
              <pre>{{.Verbose}}</pre>
            </details>
            {{end}}
            {{if .Logs}}
            {{ $item := . }}
            <div class="chart">
              <svg class="timeline" width="100%" height="34" viewBox="0 0 220 34" preserveAspectRatio="xMidYMid meet">
                <line x1="0" y1="17" x2="220" y2="17"></line>
                {{ $total := len .Logs }}
                {{range $i, $log := .Logs}}
                  {{ $cls := "" }}
                  {{if $log.Changed}}{{$cls = (printf "%s %s" $cls "changed")}}{{end}}
                  {{if $log.Error}}{{$cls = (printf "%s %s" $cls "error")}}{{end}}
                  <circle cx="{{chartX $i $total}}" cy="17" r="5" class="{{$cls}}">
                    <title>{{$log.At}}</title>
                  </circle>
				{{end}}
              </svg>
            </div>
            <details data-item="{{.Name}}" class="detail-box">
              <summary>Detail log (latest {{len .Logs}})</summary>
              {{if eq .Name "FileChangeCapturer"}}
                <div class="hint">Max files: {{.Meta.MaxFiles}}</div>
              {{end}}
              {{range .Logs}}
              <div class="hint">{{.At}}</div>
              {{if .Error}}<div class="error">{{.Error}}</div>{{end}}
              {{if .Info}}<pre>{{.Info}}</pre>{{end}}
              {{if .Verbose}}<pre>{{.Verbose}}</pre>{{end}}
              {{end}}
            </details>
            {{end}}
            {{if .Logs}}
            {{end}}
          {{end}}
        </div>
      </div>
      {{end}}
    </div>
  </div>

  <div id="rulesModal" class="modal">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;">
        <div>
          <div class="title" style="font-size:20px;">Rules</div>
          <div class="hint">Create and tune detections without restarting the agent</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="ghost" id="rulesClose">Close</button>
        </div>
      </div>
      <form id="rulesForm" class="rules-form">
        <div class="rules-toolbar">
          <div class="metrics-controls">
            <input type="text" id="metricsInput" placeholder="custom.metric.name" />
            <input type="text" id="metricsExprInput" placeholder="(cpu.total_pct + mem.ram.used_pct) / 2" />
            <button type="button" class="ghost" id="metricsAdd">Add metric</button>
          </div>
          <button type="button" class="ghost" id="rulesAdd">Add rule</button>
        </div>
        <div class="rules-layout">
          <div class="metrics-panel">
            <div class="metrics-title">Default Metrics</div>
            <div class="hint" id="metricsDefaultCount"></div>
            <div id="metricsDefaultList" class="metrics-list"></div>
            <div class="metrics-title" style="margin-top:12px;">Custom Metrics</div>
            <div class="hint" id="metricsCustomCount"></div>
            <div id="metricsList" class="metrics-list"></div>
            <div class="hint" id="metricsStatus"></div>
          </div>
          <div class="rules-table-wrap">
            <table class="rules-table">
              <thead>
                <tr>
                  <th>On</th>
                  <th>ID</th>
                  <th>Title</th>
                  <th>Severity</th>
                  <th>Metric</th>
                  <th>Op</th>
                  <th>Value</th>
                  <th>Source</th>
                  <th>Message</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody id="rulesTableBody"></tbody>
            </table>
          </div>
        </div>
        <datalist id="rule-metrics"></datalist>
        <div class="hint">Custom metrics support + - * / and parentheses. Message placeholders: {metric}, {value}, {threshold}</div>
        <div class="hint" id="rulesStatus"></div>
        <div style="display:flex;gap:8px;">
          <button type="submit" class="primary-button">Save</button>
          <button type="button" class="ghost" id="rulesRefresh">Reset</button>
        </div>
      </form>
    </div>
  </div>

  <div id="alertDetailModal" class="modal">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap;">
        <div>
          <div class="title" style="font-size:20px;">Alert detail</div>
          <div class="hint" id="alertDetailAt"></div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="ghost" id="alertDetailClose">Close</button>
        </div>
      </div>
      <div class="alert-detail-grid">
        <div>
          <span class="alert-detail-label">Severity</span>
          <span class="pill" id="alertDetailSeverity"></span>
        </div>
        <div>
          <span class="alert-detail-label">Rule</span>
          <div id="alertDetailRule"></div>
        </div>
        <div>
          <span class="alert-detail-label">Source</span>
          <div id="alertDetailSource"></div>
        </div>
        <div>
          <span class="alert-detail-label">ID</span>
          <div id="alertDetailId"></div>
        </div>
      </div>
      <div style="margin-top:12px;">
        <span class="alert-detail-label">Title</span>
        <div id="alertDetailTitle"></div>
      </div>
      <div style="margin-top:12px;">
        <span class="alert-detail-label">Message</span>
        <div id="alertDetailMessage"></div>
      </div>
      <div style="margin-top:12px;">
        <span class="alert-detail-label">Evidence</span>
        <pre class="alert-detail-pre" id="alertDetailEvidence"></pre>
      </div>
      <div style="margin-top:12px;">
        <span class="alert-detail-label">Meta</span>
        <pre class="alert-detail-pre" id="alertDetailMeta"></pre>
      </div>
      <div style="margin-top:12px;">
        <span class="alert-detail-label">Correlated</span>
        <pre class="alert-detail-pre" id="alertDetailRelated"></pre>
      </div>
    </div>
  </div>
</body>
<script>
  (function() {
    const autoBox = document.getElementById('autoRefresh');
    const eventBox = document.getElementById('eventRefresh');
    const input = document.getElementById('refreshInterval');
    const metaEl = document.querySelector('.meta');
    const gridEl = document.querySelector('.grid');
    const rulesBtn = document.getElementById('rulesBtn');
    const rulesModal = document.getElementById('rulesModal');
    const rulesClose = document.getElementById('rulesClose');
    const rulesRefresh = document.getElementById('rulesRefresh');
    const rulesForm = document.getElementById('rulesForm');
    const rulesStatus = document.getElementById('rulesStatus');
    const rulesTableBody = document.getElementById('rulesTableBody');
    const rulesAdd = document.getElementById('rulesAdd');
    const ruleMetrics = document.getElementById('rule-metrics');
    const metricsInput = document.getElementById('metricsInput');
    const metricsExprInput = document.getElementById('metricsExprInput');
    const metricsAdd = document.getElementById('metricsAdd');
    const metricsList = document.getElementById('metricsList');
    const metricsDefaultList = document.getElementById('metricsDefaultList');
    const metricsStatus = document.getElementById('metricsStatus');
    const metricsDefaultCount = document.getElementById('metricsDefaultCount');
    const metricsCustomCount = document.getElementById('metricsCustomCount');
    const alertDetailModal = document.getElementById('alertDetailModal');
    const alertDetailClose = document.getElementById('alertDetailClose');
    const alertDetailAt = document.getElementById('alertDetailAt');
    const alertDetailSeverity = document.getElementById('alertDetailSeverity');
    const alertDetailRule = document.getElementById('alertDetailRule');
    const alertDetailSource = document.getElementById('alertDetailSource');
    const alertDetailId = document.getElementById('alertDetailId');
    const alertDetailTitle = document.getElementById('alertDetailTitle');
    const alertDetailMessage = document.getElementById('alertDetailMessage');
    const alertDetailEvidence = document.getElementById('alertDetailEvidence');
    const alertDetailMeta = document.getElementById('alertDetailMeta');
    const alertDetailRelated = document.getElementById('alertDetailRelated');
    let alertFilterState = {severity: '', text: ''};
    let rulesBackdropPress = false;
    let alertBackdropPress = false;
    const storageKeyAuto = 'miniedr:auto';
    const storageKeyAutoInterval = 'miniedr:autoInterval';
    const storageKeyEvent = 'miniedr:event';
    let timer = null;
    let es = null;
    let lastRulesData = null;

    function wireAlertFilters() {
      const severitySel = document.getElementById('alertFilterSeverity');
      const textInput = document.getElementById('alertFilterText');
      const clearBtn = document.getElementById('alertFilterClear');
      const list = document.getElementById('alertHistoryList');
      if (!severitySel || !textInput || !clearBtn) return;

      const applyFilter = () => {
        const sev = severitySel.value.trim().toLowerCase();
        const q = textInput.value.trim().toLowerCase();
        if (list) {
          const items = list.querySelectorAll('li');
          items.forEach((li) => {
            const liSev = (li.getAttribute('data-severity') || '').toLowerCase();
            const liText = (li.getAttribute('data-text') || '').toLowerCase();
            const sevOk = !sev || liSev === sev;
            const textOk = !q || liText.includes(q);
            li.style.display = sevOk && textOk ? '' : 'none';
          });
        }
        alertFilterState = {severity: severitySel.value, text: textInput.value};
      };

      severitySel.onchange = applyFilter;
      textInput.oninput = applyFilter;
      clearBtn.onclick = () => {
        severitySel.value = '';
        textInput.value = '';
        applyFilter();
      };

      if (alertFilterState.severity || alertFilterState.text) {
        severitySel.value = alertFilterState.severity;
        textInput.value = alertFilterState.text;
      }
      applyFilter();
      wireAlertDetails();
    }

    function formatDetail(value, emptyLabel) {
      if (!value) return emptyLabel;
      try {
        const parsed = JSON.parse(value);
        if (Array.isArray(parsed) && parsed.length === 0) return emptyLabel;
        if (!Array.isArray(parsed) && parsed && typeof parsed === 'object' && Object.keys(parsed).length === 0) {
          return emptyLabel;
        }
        return JSON.stringify(parsed, null, 2);
      } catch (_) {
        return value;
      }
    }

    function openAlertDetail(li) {
      if (!li || !alertDetailModal) return;
      const sev = li.getAttribute('data-severity') || '';
      const rule = li.getAttribute('data-rule') || '';
      const src = li.getAttribute('data-source') || '';
      const id = li.getAttribute('data-id') || '';
      const at = li.getAttribute('data-at') || '';
      const title = li.getAttribute('data-title') || '';
      const msg = li.getAttribute('data-message') || '';
      if (alertDetailAt) alertDetailAt.textContent = at;
      if (alertDetailSeverity) {
        alertDetailSeverity.textContent = sev || 'unknown';
        alertDetailSeverity.className = 'pill severity-' + (sev || 'info');
      }
      if (alertDetailRule) alertDetailRule.textContent = rule;
      if (alertDetailSource) alertDetailSource.textContent = src;
      if (alertDetailId) alertDetailId.textContent = id;
      if (alertDetailTitle) alertDetailTitle.textContent = title;
      if (alertDetailMessage) alertDetailMessage.textContent = msg;
      if (alertDetailEvidence) {
        alertDetailEvidence.textContent = formatDetail(li.getAttribute('data-evidence'), 'No evidence captured.');
      }
      if (alertDetailMeta) {
        alertDetailMeta.textContent = formatDetail(li.getAttribute('data-meta'), 'No meta captured.');
      }
      if (alertDetailRelated) {
        alertDetailRelated.textContent = formatDetail(li.getAttribute('data-related'), 'No correlated alerts.');
      }
      alertDetailModal.classList.add('show');
    }

    function closeAlertDetail() {
      if (alertDetailModal) alertDetailModal.classList.remove('show');
    }

    function wireAlertDetails() {
      const list = document.getElementById('alertHistoryList');
      if (!list) return;
      const items = list.querySelectorAll('li');
      items.forEach((li) => {
        li.onclick = () => openAlertDetail(li);
      });
    }

    async function refreshView() {
      const detailState = Array.from(document.querySelectorAll('.grid details')).map(el => ({
        name: el.getAttribute('data-item') || '',
        open: el.hasAttribute('open'),
        scroll: el.scrollTop,
      }));
      try {
        const res = await fetch(window.location.href, {cache: 'no-store'});
        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const newMeta = doc.querySelector('.meta');
        const newGrid = doc.querySelector('.grid');
        const newAlertBody = doc.getElementById('alertHistoryBody');
        const alertBody = document.getElementById('alertHistoryBody');
        if (newMeta && metaEl) metaEl.innerHTML = newMeta.innerHTML;
        if (newGrid && gridEl) {
          gridEl.innerHTML = newGrid.innerHTML;
          detailState.forEach(state => {
            if (!state.name) return;
            const el = gridEl.querySelector('details[data-item="' + state.name + '"]');
            if (!el) return;
            if (state.open) {
              el.setAttribute('open', '');
            }
            el.scrollTop = state.scroll;
          });
        }
        if (newAlertBody && alertBody) {
          alertBody.innerHTML = newAlertBody.innerHTML;
          wireAlertFilters();
        }
      } catch (e) {
        console.error('refresh failed', e);
      }
    }

    function createRuleRow(rule) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" class="rule-enabled" /></td>
        <td><input type="text" class="rule-id" /></td>
        <td><input type="text" class="rule-title" /></td>
        <td>
          <select class="rule-severity">
            <option value="info">info</option>
            <option value="low">low</option>
            <option value="medium">medium</option>
            <option value="high">high</option>
            <option value="critical">critical</option>
          </select>
        </td>
        <td><input type="text" class="rule-metric" placeholder="cpu.total_pct" list="rule-metrics" /></td>
        <td>
          <select class="rule-op">
            <option value=">">&gt;</option>
            <option value=">=">&gt;=</option>
            <option value="<">&lt;</option>
            <option value="<=">&lt;=</option>
            <option value="==">==</option>
            <option value="!=">!=</option>
          </select>
        </td>
        <td><input type="number" class="rule-value" step="any" /></td>
        <td><input type="text" class="rule-source" placeholder="CPU" /></td>
        <td><input type="text" class="rule-message" placeholder="CPU {value}% exceeds {threshold}%" /></td>
        <td><button type="button" class="ghost rule-remove">Remove</button></td>
      `;
      const enabled = rule.enabled !== false;
      tr.querySelector('.rule-enabled').checked = enabled;
      tr.querySelector('.rule-id').value = rule.id || '';
      tr.querySelector('.rule-title').value = rule.title || '';
      tr.querySelector('.rule-severity').value = (rule.severity || 'info').toLowerCase();
      tr.querySelector('.rule-metric').value = rule.metric || '';
      tr.querySelector('.rule-op').value = rule.op || '>=';
      tr.querySelector('.rule-value').value = rule.value !== undefined ? rule.value : '';
      tr.querySelector('.rule-source').value = rule.source || '';
      tr.querySelector('.rule-message').value = rule.message || '';
      tr.querySelector('.rule-remove').onclick = () => tr.remove();
      return tr;
    }

    function renderRulesTable(rules) {
      if (!rulesTableBody) return;
      rulesTableBody.innerHTML = '';
      (rules || []).forEach((rule) => {
        rulesTableBody.appendChild(createRuleRow(rule));
      });
    }

    function nextRuleId() {
      if (!rulesTableBody) return 'custom.rule.1';
      return 'custom.rule.' + (rulesTableBody.querySelectorAll('tr').length + 1);
    }

    async function loadRulesIntoForm() {
      if (!rulesForm) return;
      try {
        const res = await fetch('/rules', {cache: 'no-store'});
        if (!res.ok) throw new Error('load failed');
        const data = await res.json();
        lastRulesData = data;
        renderRulesTable(data.rules || []);
        if (rulesStatus) rulesStatus.textContent = '';
      } catch (err) {
        if (rulesStatus) rulesStatus.textContent = 'Error loading rules';
      }
    }

    function updateMetricsDatalist(list) {
      if (!ruleMetrics) return;
      ruleMetrics.innerHTML = '';
      (list || []).forEach((metric) => {
        const opt = document.createElement('option');
        opt.value = metric;
        ruleMetrics.appendChild(opt);
      });
    }

    function collectMetricsFromList() {
      if (!metricsList) return [];
      const rows = metricsList.querySelectorAll('.metrics-row');
      const seen = new Set();
      const out = [];
      rows.forEach((row) => {
        const inputs = row.querySelectorAll('input');
        const name = (inputs[0] && inputs[0].value || '').trim();
        const expr = (inputs[1] && inputs[1].value || '').trim();
        if (!name || seen.has(name)) return;
        seen.add(name);
        out.push({name: name, expr: expr});
      });
      return out;
    }

    function renderDefaultMetrics(list) {
      if (!metricsDefaultList) return;
      metricsDefaultList.innerHTML = '';
      (list || []).forEach((metric) => {
        const row = document.createElement('div');
        row.className = 'metrics-row';
        const input = document.createElement('input');
        input.type = 'text';
        input.value = metric;
        input.disabled = true;
        row.appendChild(input);
        metricsDefaultList.appendChild(row);
      });
      if (metricsDefaultCount) {
        const count = (list || []).length;
        metricsDefaultCount.textContent = count + " metric" + (count === 1 ? "" : "s") + " available";
      }
    }

    function renderCustomMetrics(list) {
      if (!metricsList) return;
      metricsList.innerHTML = '';
      (list || []).forEach((metric) => {
        const row = document.createElement('div');
        row.className = 'metrics-row';
        const input = document.createElement('input');
        input.type = 'text';
        input.value = metric.name || '';
        input.addEventListener('change', () => persistMetrics());
        const expr = document.createElement('input');
        expr.type = 'text';
        expr.placeholder = '(cpu.total_pct + mem.ram.used_pct) / 2';
        expr.value = metric.expr || '';
        expr.addEventListener('change', () => persistMetrics());
        const remove = document.createElement('button');
        remove.type = 'button';
        remove.className = 'ghost';
        remove.textContent = 'Remove';
        remove.addEventListener('click', () => {
          row.remove();
          persistMetrics();
        });
        row.appendChild(input);
        row.appendChild(expr);
        row.appendChild(remove);
        metricsList.appendChild(row);
      });
      if (metricsCustomCount) {
        const count = (list || []).length;
        metricsCustomCount.textContent = count + " metric" + (count === 1 ? "" : "s") + " available";
      }
    }

    async function persistMetrics() {
      const payload = collectMetricsFromList();
      try {
        const res = await fetch('/metrics', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({custom: payload}),
        });
        const text = await res.text();
        if (!res.ok) throw new Error(text || 'failed to save metrics');
        let data = {};
        try { data = JSON.parse(text); } catch (_) {}
        updateMetricsDatalist((data.all || []));
        renderDefaultMetrics(data.default || []);
        renderCustomMetrics(data.custom || []);
        if (metricsStatus) {
          const ts = new Date().toLocaleTimeString();
          metricsStatus.textContent = "Metrics saved at " + ts;
        }
      } catch (err) {
        if (metricsStatus) {
          metricsStatus.textContent = "Metrics error: " + err.message;
        }
      }
    }

    async function loadMetricsList() {
      if (!ruleMetrics) return;
      try {
        const res = await fetch('/metrics', {cache: 'no-store'});
        if (!res.ok) throw new Error('load failed');
        const data = await res.json();
        updateMetricsDatalist((data.all || []));
        renderDefaultMetrics(data.default || []);
        renderCustomMetrics(data.custom || []);
      } catch (err) {
        updateMetricsDatalist([]);
        renderDefaultMetrics([]);
        renderCustomMetrics([]);
      }
    }

    function openRules() {
      if (rulesModal) rulesModal.classList.add('show');
      loadMetricsList();
      loadRulesIntoForm();
    }
    function closeRules() {
      if (rulesModal) rulesModal.classList.remove('show');
    }

    async function submitRules(e) {
      e.preventDefault();
      if (!rulesForm) return;
      const payload = {rules: []};
      if (rulesTableBody) {
        const rows = rulesTableBody.querySelectorAll('tr');
        rows.forEach((row) => {
          const metric = row.querySelector('.rule-metric').value.trim();
          if (!metric) return;
          const rule = {
            id: row.querySelector('.rule-id').value.trim(),
            title: row.querySelector('.rule-title').value.trim(),
            severity: row.querySelector('.rule-severity').value.trim(),
            metric: metric,
            op: row.querySelector('.rule-op').value.trim(),
            value: parseFloat(row.querySelector('.rule-value').value) || 0,
            source: row.querySelector('.rule-source').value.trim(),
            message: row.querySelector('.rule-message').value.trim(),
            enabled: row.querySelector('.rule-enabled').checked,
          };
          payload.rules.push(rule);
        });
      }
      try {
        const res = await fetch('/rules', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(payload),
        });
        const text = await res.text();
        if (!res.ok) throw new Error(text || 'failed to save');
        let data = {};
        try { data = JSON.parse(text); } catch (_) {}
        if (rulesStatus) {
          const ts = new Date().toLocaleTimeString();
          rulesStatus.textContent = "Saved at " + ts;
        }
        // refresh view to pick up new thresholds (and any alert changes)
        refreshView();
      } catch (err) {
        if (rulesStatus) {
          rulesStatus.textContent = "Error: " + err.message;
        }
        console.error(err);
      }
    }

    function applyAuto() {
      clearInterval(timer);
      const enabled = autoBox.checked;
      let sec = parseInt(input.value, 10);
      if (isNaN(sec) || sec <= 0) sec = {{.RefreshSecs}};
      input.value = sec;

      if (enabled) {
        // turning on timed refresh disables event-driven refresh
        eventBox.checked = false;
        applyEvent(false);
      }

      localStorage.setItem(storageKeyAuto, enabled ? '1' : '0');
      localStorage.setItem(storageKeyAutoInterval, sec.toString());

      if (enabled) {
        timer = setInterval(refreshView, sec * 1000);
      }
    }

    function stopEventStream() {
      if (es) {
        es.close();
        es = null;
      }
    }

    function applyEvent(forceEnabled) {
      const enabled = typeof forceEnabled === 'boolean' ? forceEnabled : eventBox.checked;
      eventBox.checked = enabled;
      localStorage.setItem(storageKeyEvent, enabled ? '1' : '0');
      stopEventStream();
      if (enabled) {
        // turning on event refresh disables timed refresh
        autoBox.checked = false;
        clearInterval(timer);
        localStorage.setItem(storageKeyAuto, '0');
        es = new EventSource('/events');
        es.onmessage = refreshView;
        es.onerror = () => stopEventStream();
      }
    }

    // Restore user prefs
    const savedAuto = localStorage.getItem(storageKeyAuto);
    if (savedAuto !== null) {
      autoBox.checked = savedAuto === '1';
    }
    const savedEvent = localStorage.getItem(storageKeyEvent);
    if (savedEvent !== null) {
      eventBox.checked = savedEvent === '1';
    }
    const savedSec = localStorage.getItem(storageKeyAutoInterval);
    if (savedSec !== null && savedSec !== '') {
      input.value = savedSec;
    }

    if (rulesForm) {
      rulesForm.addEventListener('submit', submitRules);
    }
    if (metricsAdd) {
      metricsAdd.addEventListener('click', () => {
        if (!metricsInput || !metricsExprInput || !metricsList) return;
        const val = metricsInput.value.trim();
        const exprVal = metricsExprInput.value.trim();
        if (!val || !exprVal) return;
        const row = document.createElement('div');
        row.className = 'metrics-row';
        const input = document.createElement('input');
        input.type = 'text';
        input.value = val;
        input.addEventListener('change', () => persistMetrics());
        const expr = document.createElement('input');
        expr.type = 'text';
        expr.placeholder = '(cpu.total_pct + mem.ram.used_pct) / 2';
        expr.value = exprVal;
        expr.addEventListener('change', () => persistMetrics());
        const remove = document.createElement('button');
        remove.type = 'button';
        remove.className = 'ghost';
        remove.textContent = 'Remove';
        remove.addEventListener('click', () => {
          row.remove();
          persistMetrics();
        });
        row.appendChild(input);
        row.appendChild(expr);
        row.appendChild(remove);
        metricsList.appendChild(row);
        metricsInput.value = '';
        metricsExprInput.value = '';
        persistMetrics();
      });
    }
    if (rulesAdd) {
      rulesAdd.addEventListener('click', () => {
        if (!rulesTableBody) return;
        rulesTableBody.appendChild(createRuleRow({
          id: nextRuleId(),
          severity: 'info',
          op: '>=',
          value: 0,
          enabled: true,
        }));
      });
    }
    autoBox.addEventListener('change', applyAuto);
    eventBox.addEventListener('change', () => applyEvent());
    input.addEventListener('change', applyAuto);
    document.getElementById('refreshBtn').onclick = refreshView;
    if (rulesBtn) rulesBtn.onclick = openRules;
    if (rulesClose) rulesClose.onclick = closeRules;
    if (rulesRefresh) {
      rulesRefresh.addEventListener('click', (e) => {
        e.preventDefault();
        if (lastRulesData) {
          renderRulesTable(lastRulesData.rules || []);
          if (rulesStatus) rulesStatus.textContent = '';
          return;
        }
        if (rulesForm) rulesForm.reset();
        loadRulesIntoForm();
      });
    }
    if (rulesModal) {
      rulesModal.addEventListener('mousedown', (e) => {
        rulesBackdropPress = e.target === rulesModal;
      });
      rulesModal.addEventListener('mouseup', (e) => {
        if (rulesBackdropPress && e.target === rulesModal) closeRules();
        rulesBackdropPress = false;
      });
      rulesModal.addEventListener('mouseleave', () => {
        rulesBackdropPress = false;
      });
    }
    if (alertDetailModal) {
      alertDetailModal.addEventListener('mousedown', (e) => {
        alertBackdropPress = e.target === alertDetailModal;
      });
      alertDetailModal.addEventListener('mouseup', (e) => {
        if (alertBackdropPress && e.target === alertDetailModal) closeAlertDetail();
        alertBackdropPress = false;
      });
      alertDetailModal.addEventListener('mouseleave', () => {
        alertBackdropPress = false;
      });
    }
    if (alertDetailClose) alertDetailClose.onclick = closeAlertDetail;

    wireAlertFilters();
    applyAuto();
    applyEvent();
  })();
</script>
</html>
